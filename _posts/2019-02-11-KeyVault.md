---
layout: post
title: KeyVault
---

I'm always looking for ways to simply automate deployments, so I dont have to hard code, or repeat myself.
At the momemt I was looking at Key Vault deployments, and its use.

## Parameters

For Key Vaults I dont like to specify the normal keyvalue pairs, as it would mean that I have to specify the name of the secret within the deployment script.
The obvious draw back here is, as the code evolves and the secret changes then you would need to update both the parameters plus the deployment script.
So first off in the parameters file put the secrets into an array.

```
    "para_kvSecretsObject": {
      "value": {
        "secrets": [
          {
            "secretName": "applicationuser",
            "secretValue": "OVERWRITTEN BY VSTS"
          },
          {
            "secretName": "AnotherSecret",
            "secretValue": "OVERWRITTEN BY VSTS"
          }
        ]
      }
```

Straight away you can see that the actual secret is injected from the CI tool, this is so you can inject a different secret depending on the environment.
Puting the secrets into an aray in this way means that we can cycle through the array in the deployment script without actually refereing to the secret itself, ourely using the array index.

## Load Secrets

```
    {
      "apiVersion": "2015-06-01",
      "copy": {
        "name": "secretsCopy",
        "count": "[length(parameters('para_kvSecretsObject').secrets)]"
      },
      "dependsOn": [
        "[concat('Microsoft.KeyVault/vaults/', variables('var_kv_name'))]"
      ],
      "name": "[concat(variables('var_kv_name'), '/', parameters('para_kvSecretsObject').secrets[copyIndex()].secretName)]",
      "properties": {
        "value": "[parameters('para_kvSecretsObject').secrets[copyIndex()].secretValue]"
      },
      "tags": {
        "displayName": "Key Vault Secrets"
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    }

```
